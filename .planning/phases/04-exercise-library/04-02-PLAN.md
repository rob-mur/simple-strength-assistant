---
phase: 04-exercise-library
plan: 02
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - src/app.rs
  - src/components/mod.rs
  - src/components/workout_view.rs
  - src/components/library_view.rs
  - src/components/tab_bar.rs
  - tests/steps/tab_navigation.rs
  - Cargo.toml
autonomous: true
requirements:
  - LIB-01
  - LIB-02

must_haves:
  truths:
    - "User can see Workout and Library tabs in the interface"
    - "User can click Library tab and see placeholder content"
    - "User can switch back to Workout tab and see active session preserved"
    - "Tab selection persists when user refreshes browser"
  artifacts:
    - path: "src/components/tab_bar.rs"
      provides: "Tab navigation UI component"
      min_lines: 80
    - path: "src/components/workout_view.rs"
      provides: "Extracted workout interface as separate view"
      min_lines: 50
    - path: "src/components/library_view.rs"
      provides: "Library placeholder view"
      min_lines: 30
    - path: "src/app.rs"
      provides: "Conditional rendering based on tab state"
      contains: "match active_tab()"
  key_links:
    - from: "src/app.rs"
      to: "src/components/tab_bar.rs"
      via: "Signal prop passing"
      pattern: "TabBar.*active_tab.*on_change"
    - from: "src/app.rs"
      to: "use_context_provider(WorkoutState)"
      via: "Context provider at root"
      pattern: "use_context_provider.*WorkoutState"
    - from: "src/components/tab_bar.rs"
      to: "gloo_storage::LocalStorage"
      via: "localStorage persistence"
      pattern: "LocalStorage::set.*active_tab"
---

<objective>
Implement tab navigation UI with conditional view rendering and state preservation. This delivers the navigation infrastructure for the Exercise Library milestone.

Purpose: Enable users to navigate between Workout and Library without losing their active workout session, satisfying requirements LIB-01 and LIB-02.

Output: Working tab navigation with WorkoutView and LibraryView components, tab state persisted to localStorage, and all BDD tests passing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-exercise-library/04-CONTEXT.md
@.planning/phases/04-exercise-library/04-RESEARCH.md
@.planning/phases/04-exercise-library/04-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts from existing codebase -->

From src/app.rs (lines 70-72):
```rust
pub fn App() -> Element {
    let workout_state = use_context_provider(WorkoutState::new);
    // ... WorkoutState provided at root level
}
```

From src/app.rs (lines 556-590):
```rust
#[component]
fn WorkoutInterface(state: WorkoutState) -> Element {
    let current_session = state.current_session();
    // Renders either ActiveSession or StartSessionView
}
```

From src/state/workout_state.rs:
```rust
pub struct WorkoutState {
    // Interior mutability with Rc<RefCell<T>>
    pub fn current_session(&self) -> Option<WorkoutSession>
    pub fn set_current_session(&self, session: Option<WorkoutSession>)
}
```

From Cargo.toml (existing dependencies):
```toml
gloo-storage = "0.3"
serde = { version = "1.0", features = ["derive"] }
```
</interfaces>

<architecture_patterns>
From 04-RESEARCH.md - Conditional rendering pattern:
```rust
#[derive(Clone, Copy, PartialEq, Serialize, Deserialize)]
enum Tab {
    Workout,
    Library,
}

#[component]
pub fn App() -> Element {
    let workout_state = use_context_provider(WorkoutState::new);
    let mut active_tab = use_signal(|| {
        LocalStorage::get("active_tab").unwrap_or(Tab::Workout)
    });

    rsx! {
        main {
            match active_tab() {
                Tab::Workout => rsx! { WorkoutView {} },
                Tab::Library => rsx! { LibraryView {} },
            }
        }
        TabBar {
            active_tab: active_tab(),
            on_change: move |tab| {
                active_tab.set(tab);
                let _ = LocalStorage::set("active_tab", &tab);
            }
        }
    }
}
```

From 04-RESEARCH.md - DaisyUI tabs:
```rust
div {
    role: "tablist",
    class: "tabs tabs-boxed fixed bottom-0 left-0 right-0 bg-base-100 shadow-lg",
    button {
        role: "tab",
        class: if active_tab == Tab::Workout { "tab tab-active" } else { "tab" },
        onclick: move |_| on_change.call(Tab::Workout),
        "Workout"
    }
}
```
</architecture_patterns>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create component directory structure and extract WorkoutView</name>
  <files>
    src/components/mod.rs
    src/components/workout_view.rs
    src/components/library_view.rs
    src/app.rs
  </files>
  <action>
Create src/components/ directory if it doesn't exist (tape_measure.rs and related components already there).

**Create src/components/mod.rs:**
```rust
pub mod rpe_slider;
pub mod step_controls;
pub mod tape_measure;
pub mod tab_bar;
pub mod workout_view;
pub mod library_view;
```

**Create src/components/workout_view.rs:**
Extract the `WorkoutInterface` component from src/app.rs (lines 556-590) and rename to `WorkoutView`. Keep the same logic: renders `ActiveSession` if current_session exists, otherwise `StartSessionView`.

Component should accept `state: WorkoutState` prop and use `state.current_session()` to determine which view to render. No changes to logic, just extraction and rename.

**Create src/components/library_view.rs:**
```rust
use dioxus::prelude::*;

#[component]
pub fn LibraryView() -> Element {
    rsx! {
        div {
            class: "max-w-2xl mx-auto",
            div {
                class: "card bg-base-100 shadow-xl",
                div {
                    class: "card-body text-center",
                    h2 {
                        class: "card-title text-2xl mb-4 justify-center",
                        "Exercise Library"
                    }
                    p {
                        class: "text-base-content/70",
                        "Library view coming in Phase 5..."
                    }
                }
            }
        }
    }
}
```

**Update src/app.rs:**
- Add imports: `use crate::components::{workout_view::WorkoutView, library_view::LibraryView};`
- Remove `WorkoutInterface` component (now in workout_view.rs)
- Keep all other components (`StartSessionView`, `ActiveSession`) in app.rs for now
- Update the Ready state rendering (line 386-457) to use `WorkoutView { state: workout_state }` instead of `WorkoutInterface`

Do NOT add tab navigation yet - that's Task 2. This task only extracts components.
  </action>
  <verify>
    <automated>cargo build --target wasm32-unknown-unknown 2>&1 | grep -q "Finished" && grep -q "pub mod workout_view" src/components/mod.rs && grep -q "pub fn WorkoutView" src/components/workout_view.rs && grep -q "pub fn LibraryView" src/components/library_view.rs</automated>
  </verify>
  <done>
src/components/ directory exists with mod.rs, workout_view.rs, and library_view.rs. WorkoutView extracted from app.rs with same behavior. LibraryView placeholder created. WASM build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TabBar component with tab state and localStorage persistence</name>
  <files>
    src/components/tab_bar.rs
    src/components/mod.rs
    src/app.rs
    Cargo.toml
  </files>
  <action>
**Create src/components/tab_bar.rs:**

Define Tab enum and TabBar component following 04-RESEARCH.md patterns:

```rust
use dioxus::prelude::*;
use gloo_storage::{LocalStorage, Storage};
use serde::{Deserialize, Serialize};

#[derive(Clone, Copy, PartialEq, Debug, Serialize, Deserialize)]
pub enum Tab {
    Workout,
    Library,
}

impl Tab {
    pub fn as_str(&self) -> &'static str {
        match self {
            Tab::Workout => "Workout",
            Tab::Library => "Library",
        }
    }
}

#[component]
pub fn TabBar(active_tab: Tab, on_change: EventHandler<Tab>) -> Element {
    rsx! {
        div {
            role: "tablist",
            class: "tabs tabs-boxed fixed bottom-0 left-0 right-0 bg-base-100 shadow-lg z-50 p-2",

            button {
                role: "tab",
                class: if active_tab == Tab::Workout {
                    "tab tab-active"
                } else {
                    "tab"
                },
                onclick: move |_| on_change.call(Tab::Workout),
                "Workout"
            }

            button {
                role: "tab",
                class: if active_tab == Tab::Library {
                    "tab tab-active"
                } else {
                    "tab"
                },
                onclick: move |_| on_change.call(Tab::Library),
                "Library"
            }
        }
    }
}
```

**Update src/components/mod.rs:**
Add `pub mod tab_bar;` export.

**Update src/app.rs:**
1. Add imports at top:
   ```rust
   use crate::components::tab_bar::{Tab, TabBar};
   use gloo_storage::{LocalStorage, Storage};
   use serde::{Deserialize, Serialize};
   ```

2. In `App` component (after line 71 `let workout_state = use_context_provider(WorkoutState::new);`), add:
   ```rust
   let mut active_tab = use_signal(|| {
       LocalStorage::get("active_tab").unwrap_or(Tab::Workout)
   });
   ```

3. In the Ready state rendering (around line 451), replace:
   ```rust
   rsx! {
       div {
           {storage_mode_banner}
           {save_error_banner}
           WorkoutView { state: workout_state }
       }
   }
   ```
   with:
   ```rust
   rsx! {
       div {
           class: "pb-20", // Padding for fixed bottom tab bar
           {storage_mode_banner}
           {save_error_banner}
           match active_tab() {
               Tab::Workout => rsx! { WorkoutView { state: workout_state } },
               Tab::Library => rsx! { LibraryView {} },
           }
       }
       TabBar {
           active_tab: active_tab(),
           on_change: move |tab| {
               active_tab.set(tab);
               let _ = LocalStorage::set("active_tab", &tab);
           }
       }
   }
   ```

**Verify Cargo.toml has dependencies** (should already exist per STACK.md):
- gloo-storage = "0.3"
- serde with derive feature

If missing, add them to [dependencies] section.
  </action>
  <verify>
    <automated>dx build --release 2>&1 | grep -q "Finished" && grep -q "pub enum Tab" src/components/tab_bar.rs && grep -q "active_tab()" src/app.rs && grep -q "LocalStorage::set" src/app.rs</automated>
  </verify>
  <done>
TabBar component exists with Tab enum and localStorage integration. App.rs uses conditional rendering based on active_tab Signal. Tab selection persists to localStorage on change. Dioxus build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement BDD step definitions and run tests</name>
  <files>tests/steps/tab_navigation.rs</files>
  <action>
Replace todo!() stubs in tests/steps/tab_navigation.rs with implementations for both feature files.

For @unit scenarios (mocked tests):
- Use direct component instantiation and state inspection
- Mock localStorage using test fixtures
- Test tab state Signal behavior
- Test WorkoutState context preservation

For @e2e scenarios (Playwright tests):
- Use playwright-bdd patterns from existing tests/e2e/features/
- Test actual DOM interactions (click, navigation)
- Verify localStorage persistence across page refresh
- Verify workout session state survives tab switching

Follow patterns from existing test step files. Key implementations:

**Given steps:**
- "the app is initialized" -> Set up test world with WorkoutState
- "user has an active workout session" -> Create session in WorkoutState
- "user is on the Workout tab" -> Set active_tab to Tab::Workout

**When steps:**
- "user clicks Library tab" -> Trigger tab onclick handler
- "user refreshes the browser" -> Simulate localStorage read on mount
- "user clicks back to Workout tab" -> Trigger tab onclick handler

**Then steps:**
- "Workout and Library tabs are visible" -> Assert DOM contains both tabs
- "active workout session is preserved" -> Assert WorkoutState.current_session() unchanged
- "tab selection persists" -> Assert localStorage contains "active_tab"

Run tests after implementation:
```bash
cargo test --test cucumber_tests -- --tags @unit
npm test -- tests/e2e/features/  # For @e2e if applicable
```

All scenarios from 04-01-PLAN.md should pass.
  </action>
  <verify>
    <automated>cargo test --features test-mode 2>&1 | grep -E "(test result|passed)" && grep -v "todo!" tests/steps/tab_navigation.rs</automated>
  </verify>
  <done>
All step definitions implemented (no more todo!() stubs). Unit tests pass. E2E tests pass. Requirements LIB-01 (view Library tab) and LIB-02 (switch tabs without losing session) verified by passing BDD scenarios.
  </done>
</task>

</tasks>

<verification>
**Functional verification:**
```bash
# Build and run dev server
dx serve
```

Manual checks:
1. Open http://localhost:8080
2. Create/open database
3. Start a workout session (add exercise, log a set)
4. Click "Library" tab at bottom -> see placeholder, URL unchanged
5. Click "Workout" tab -> see active session still present (set count preserved)
6. Refresh browser (F5) -> Library tab still selected (localStorage restored)
7. Click Workout tab -> session state still intact

**Automated verification:**
```bash
# Run unit tests
cargo test --features test-mode -- tab_navigation

# Run E2E tests (if playwright-bdd configured)
npm test -- tests/e2e/features/
```

**Code structure verification:**
```bash
ls -la src/components/tab_bar.rs src/components/workout_view.rs src/components/library_view.rs
grep -n "match active_tab()" src/app.rs
grep -n "LocalStorage::set" src/components/tab_bar.rs
```
</verification>

<success_criteria>
- [ ] src/components/workout_view.rs exists with extracted WorkoutView component
- [ ] src/components/library_view.rs exists with placeholder content
- [ ] src/components/tab_bar.rs exists with Tab enum and TabBar component
- [ ] src/app.rs uses conditional rendering: `match active_tab() { Tab::Workout => ..., Tab::Library => ... }`
- [ ] Tab state Signal initialized from localStorage with fallback to Tab::Workout
- [ ] Tab clicks update Signal and persist to localStorage
- [ ] WorkoutState context provider remains at root level (not recreated per tab)
- [ ] All BDD scenarios from 04-01 pass (tab navigation and state preservation)
- [ ] Manual testing confirms: tab switching preserves active workout session
- [ ] Manual testing confirms: browser refresh preserves tab selection
- [ ] Requirements LIB-01 and LIB-02 fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-exercise-library/04-02-SUMMARY.md`
</output>
